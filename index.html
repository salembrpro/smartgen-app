<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SmartGen ‚Äì Spieler & Eltern Dashboard</title>

<style>
:root{
  --bg:#070a10;
  --text:#eaf2ff;
  --muted:#a7b6cf;
  --line:rgba(255,255,255,.12);

  --accent:#ff7a18;
  --accent2:#ffb14a;

  --ok:#25d07f;
  --warn:#ffb020;
  --danger:#ff4d4d;

  --radius:20px;
  --shadow: 0 26px 80px rgba(0,0,0,.55);
  --shadow2: 0 14px 36px rgba(0,0,0,.35);

  --cardA: rgba(16,24,36,.78);
  --cardB: rgba(10,14,22,.70);

  --pGlow: 0 0 0 1px rgba(255,122,24,.26), 0 0 55px rgba(255,122,24,.18);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color:var(--text);
  background:#070a10;
  overflow-x:hidden;
}

/* BACKGROUND (Carbon + Hex) */
.bg{
  position:fixed; inset:0; z-index:-2;
  background:
    radial-gradient(900px 420px at 14% -10%, rgba(255,122,24,.14), transparent 62%),
    radial-gradient(900px 420px at 100% 10%, rgba(255,122,24,.08), transparent 64%),
    radial-gradient(900px 420px at 55% 115%, rgba(255,255,255,.06), transparent 60%),
    linear-gradient(180deg, #070a10 0%, #0b1323 55%, #070a10 100%);
}
.bg::before{
  content:"";
  position:absolute; inset:0;
  opacity:.55;
  background:
    linear-gradient(135deg, rgba(255,255,255,.05) 0 6px, rgba(0,0,0,0) 6px 12px),
    linear-gradient(315deg, rgba(255,255,255,.035) 0 6px, rgba(0,0,0,0) 6px 12px);
  background-size: 22px 22px;
  mix-blend-mode: overlay;
  filter: contrast(1.1);
}
.bg::after{
  content:"";
  position:absolute; inset:0;
  opacity:.12;
  background-image:
    radial-gradient(circle at 1px 1px, rgba(255,255,255,.25) 1px, transparent 1.2px),
    linear-gradient(60deg, rgba(255,255,255,.08) 1px, transparent 1px),
    linear-gradient(-60deg, rgba(255,255,255,.08) 1px, transparent 1px);
  background-size: 22px 22px, 44px 38px, 44px 38px;
  mix-blend-mode: screen;
}

/* Parent Mode Overlay (more orange neon) */
.parentFX{
  position:fixed; inset:0; z-index:-1;
  opacity:0; pointer-events:none;
  transition: opacity .25s ease;
  background:
    radial-gradient(900px 500px at 18% 0%, rgba(255,122,24,.22), transparent 62%),
    radial-gradient(900px 500px at 90% 20%, rgba(255,122,24,.14), transparent 62%),
    radial-gradient(900px 500px at 50% 120%, rgba(255,177,74,.10), transparent 65%);
}
body.parent .parentFX{ opacity:1; }

.wrap{max-width:1120px;margin:auto;padding:18px 14px 26px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:860px){.grid{grid-template-columns:1fr}}

.card{
  border:1px solid var(--line);
  border-radius: var(--radius);
  background: linear-gradient(180deg, var(--cardA), var(--cardB));
  box-shadow: var(--shadow);
  overflow:hidden;
}
.cardPad{padding:16px}
.hidden{display:none}

h2{margin:0 0 10px 0;font-size:18px;letter-spacing:.2px}
.small{color:var(--muted);font-size:13px;line-height:1.45}
.hr{border:none;border-top:1px solid var(--line); margin:12px 0}

/* TOP */
.top{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px;
  padding:14px 16px;
  border-bottom:1px solid var(--line);
  background:
    radial-gradient(700px 220px at 10% 0%, rgba(255,122,24,.20), transparent 60%),
    radial-gradient(700px 220px at 90% 10%, rgba(255,122,24,.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.04), transparent);
}
.brand{display:flex; align-items:center; gap:12px;}
.logoDot{
  width:46px; height:46px; border-radius:18px;
  background:
    radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), transparent 55%),
    linear-gradient(135deg, rgba(255,122,24,.95), rgba(255,177,74,.45));
  box-shadow: 0 0 0 1px rgba(255,255,255,.10), 0 18px 55px rgba(255,122,24,.18);
}
.brandTitle{font-weight:1000; letter-spacing:.2px}
.pills{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
.pill{
  display:inline-flex; align-items:center; gap:10px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.22);
  box-shadow: var(--shadow2);
  font-weight:1000;
  font-size:14px;
}
.dot{
  width:11px;height:11px;border-radius:50%;
  background: var(--ok);
  box-shadow: 0 0 0 6px rgba(37,208,127,.10);
}

/* BUTTONS (BIG + CLEAR) */
.btn{
  padding:13px 14px;
  border-radius:16px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.22);
  color: var(--text);
  font-weight:1000;
  cursor:pointer;
  font-size:15px;
}
.btn:active{transform:translateY(1px)}
.btn.primary{
  border-color: rgba(255,122,24,.75);
  background: linear-gradient(135deg, rgba(255,122,24,.22), rgba(255,255,255,.02));
  box-shadow: 0 18px 55px rgba(255,122,24,.12);
}
body.parent .btn.primary{ box-shadow: var(--pGlow); }
.btn.ok{
  border-color: rgba(37,208,127,.55);
  background: rgba(37,208,127,.12);
}
.btn.ghost{background: rgba(255,255,255,.06)}
.btn:disabled{opacity:.45; cursor:not-allowed}

/* TAGS */
.tag{
  padding:8px 12px;
  border-radius:999px;
  font-size:13px;
  font-weight:1000;
  background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.10);
  white-space:nowrap;
}
.tag.ok{background: rgba(37,208,127,.14); border-color: rgba(37,208,127,.35)}
.tag.warn{background: rgba(255,176,32,.14); border-color: rgba(255,176,32,.35)}
.tag.danger{background: rgba(255,77,77,.14); border-color: rgba(255,77,77,.35)}

/* LIST / SLOTS */
.list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.slot{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:13px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
}
.slot strong{font-size:15px; font-weight:1000}
.slot small{display:block;color:var(--muted);margin-top:4px;font-size:13px}
.slot .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}

/* Wallet / NFC Card Button */
.walletBtn{
  width:100%;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:14px;
  border-radius:18px;
  border:1px solid rgba(255,122,24,.35);
  background: linear-gradient(135deg, rgba(255,122,24,.14), rgba(0,0,0,.20));
  cursor:pointer;
  font-weight:1000;
}
.walletBtn:hover{border-color: rgba(255,122,24,.55)}
.walletBtn .left{display:flex;align-items:center;gap:12px}
.walletBtn .ic{font-size:28px}
.walletBtn .right{opacity:.9; font-size:18px}

/* MODALS */
.modalWrap{
  position:fixed; inset:0;
  background:rgba(0,0,0,.62);
  display:none;
  align-items:center; justify-content:center;
  padding:16px; z-index:50;
}
.modal{
  width:min(640px, 100%);
  background: linear-gradient(180deg, rgba(16,24,36,.94), rgba(10,14,22,.92));
  border:1px solid var(--line);
  border-radius:20px;
  overflow:hidden;
  box-shadow: 0 36px 120px rgba(0,0,0,.65);
}
.modalHead{
  padding:14px 16px;
  border-bottom:1px solid var(--line);
  display:flex; align-items:center; justify-content:space-between;
  background:
    radial-gradient(700px 220px at 15% 0%, rgba(255,122,24,.18), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.04), transparent);
}
.modalHead b{font-size:15px}
.x{
  width:46px;height:46px;border-radius:16px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.22);
  color:white;
  cursor:pointer;
  font-weight:1000;
  font-size:16px;
}
.modalBody{padding:16px}
.modalActions{
  padding:14px 16px;
  border-top:1px solid var(--line);
  display:flex; gap:10px; justify-content:flex-end;
}

.input{
  padding:14px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(0,0,0,.22);
  color: var(--text);
  width:100%;
  font-size:15px;
  outline:none;
}

.idCard{
  border-radius:22px;
  border:1px solid rgba(255,122,24,.40);
  background:
    radial-gradient(420px 240px at 20% 0%, rgba(255,122,24,.26), transparent 60%),
    radial-gradient(420px 240px at 90% 40%, rgba(255,177,74,.14), transparent 62%),
    linear-gradient(135deg, rgba(0,0,0,.25), rgba(255,255,255,.03));
  padding:16px;
  box-shadow: var(--pGlow);
}
.idTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
.idName{font-weight:1000;font-size:16px}
.idSub{color:rgba(255,230,210,.85);font-weight:900;font-size:12px}
.idGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  margin-top:12px;
}
.kv{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
  border-radius:14px;
  padding:10px;
}
.kv b{display:block;font-size:12px}
.kv span{color:rgba(255,255,255,.85);font-weight:900}
.qr{
  margin-top:12px;
  display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
}
.qrBox{
  width:120px;height:120px;border-radius:18px;
  border:1px solid rgba(255,255,255,.14);
  background:
    repeating-linear-gradient(0deg, rgba(255,255,255,.16) 0 6px, rgba(0,0,0,.0) 6px 12px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.10) 0 6px, rgba(0,0,0,.0) 6px 12px);
  opacity:.9;
}
.nfcPill{
  display:inline-flex; align-items:center; gap:10px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,122,24,.45);
  background: rgba(255,122,24,.12);
  font-weight:1000;
}

/* TOAST */
.toast{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  background: rgba(16,24,36,.94);
  border:1px solid var(--line);
  border-radius:18px;
  padding:12px 14px;
  display:none;
  z-index:60;
  font-size:14px;
  color:var(--muted);
  box-shadow: 0 18px 60px rgba(0,0,0,.55);
}
.toast b{color:var(--text)}
</style>
</head>

<body>
<div class="bg"></div>
<div class="parentFX"></div>

<div class="wrap">

  <!-- HEADER -->
  <div class="card">
    <div class="top">
      <div class="brand">
        <div class="logoDot"></div>
        <div>
          <div class="brandTitle">SmartGen Fussball Akademie</div>
          <div class="small" id="modeLabel">Modus: Spieler</div>
        </div>
      </div>

      <div class="pills">
        <div class="pill" title="Status">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">Aktiv</span>
        </div>
        <button class="btn primary" onclick="setMode('player')">‚öΩ Spieler</button>
        <button class="btn" onclick="openPin()">üë®‚Äçüë©‚Äçüë¶ Eltern</button>
      </div>
    </div>

    <div class="cardPad">
      <div class="small">
        <b>Eltern-Fitness Regel:</b> W√§hrend Kindertraining ist Eltern-Fitness <b>gesperrt</b>.
        Buchungen/Storno werden lokal gespeichert (Demo).
      </div>
    </div>
  </div>

  <div class="grid">

    <!-- LEFT -->
    <div>

      <!-- PLAYER (minimal but solid) -->
      <div id="playerDash" class="card">
        <div class="cardPad">
          <h2>‚öΩ Spieler Dashboard</h2>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0">
            <span class="tag ok">U15 ‚Ä¢ Technik & Kognition</span>
            <span class="tag ok" id="pStatusTag">Aktiv</span>
          </div>

          <button class="walletBtn" onclick="openWallet('player')">
            <div class="left">
              <span class="ic">‚öΩ</span>
              <div>
                <div style="font-weight:1000">SmartGen Spieler-ID (Wallet/NFC)</div>
                <div class="small">Tap & Check-in ‚Ä¢ QR ‚Ä¢ Zugang</div>
              </div>
            </div>
            <div class="right">‚Ä∫</div>
          </button>

          <hr class="hr">

          <h2>üü† Spieler Slots (Demo)</h2>
          <div class="small">Extra Slots au√üerhalb Training (Demo ‚Äì getrennt von Eltern-Fitness).</div>
          <div class="list" id="playerSlots"></div>

          <hr class="hr">
          <button class="btn primary" onclick="toast('‚úÖ <b>Spieler Bereich</b><br>Sp√§ter: Stats, Videos, Matchanalyse.');" style="width:100%">üìà Analyse (Demo)</button>
        </div>
      </div>

      <!-- PARENT DASH -->
      <div id="parentDash" class="hidden">

        <div class="card">
          <div class="cardPad">
            <h2>üë®‚Äçüë©‚Äçüë¶ Eltern Dashboard</h2>

            <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0">
              <span class="tag ok">Kind: Amine B.</span>
              <span class="tag ok">Vertrag: Premium</span>
            </div>

            <button class="walletBtn" onclick="openWallet('parent')">
              <div class="left">
                <span class="ic">üß°</span>
                <div>
                  <div style="font-weight:1000">Eltern NFC / Wallet Karte</div>
                  <div class="small">Orange Edition ‚Ä¢ Tap & Check-in</div>
                </div>
              </div>
              <div class="right">‚Ä∫</div>
            </button>

            <hr class="hr">

            <h2>üí¨ Kommunikation (Demo)</h2>
            <input class="input" placeholder="Nachricht an Trainer schreiben‚Ä¶" />
            <button class="btn primary" style="margin-top:10px;width:100%" onclick="toast('üì® <b>Gesendet</b><br>(Demo)');">Senden</button>

            <hr class="hr">
            <h2>üß† Eltern KI (Demo)</h2>
            <button class="btn primary" style="width:100%" onclick="toast('ü§ñ <b>KI</b><br>Als n√§chstes: Motivation + Ern√§hrung.');">Motivation + Ern√§hrung (next)</button>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div id="fitnessCard" class="card hidden">
        <div class="cardPad">
          <h2>üèãÔ∏è Eltern-Fitness (echt buchbar)</h2>
          <div class="small">Buchen / Stornieren wird gespeichert. Blockierung bei Kindertraining aktiv.</div>

          <div class="list" id="fitnessSlots"></div>

          <hr class="hr">
          <div class="small"><b>Gebucht:</b> <span id="bookCount">0</span> Slot(s)</div>
          <button class="btn ghost" style="width:100%;margin-top:10px" onclick="resetParentBookings()">Reset (Demo)</button>
        </div>
      </div>

      <div id="parentHint" class="card">
        <div class="cardPad">
          <h2>üë®‚Äçüë©‚Äçüë¶ Eltern Bereich</h2>
          <div class="small">
            Klicke oben auf <b>Eltern</b> und gib den PIN ein.
            Dann erscheint hier die Eltern-Fitness Buchung (mit Blockierung).
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- PIN MODAL -->
<div id="pinModal" class="modalWrap">
  <div class="modal">
    <div class="modalHead">
      <b>üîê Eltern-Freigabe (PIN)</b>
      <button class="x" onclick="closePin()">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="small">Demo-PIN: <b>1234</b></div>
      <div style="margin-top:10px">
        <input id="pinInput" class="input" placeholder="PIN eingeben" inputmode="numeric">
      </div>
    </div>
    <div class="modalActions">
      <button class="btn" onclick="closePin()">Abbrechen</button>
      <button class="btn primary" onclick="checkPin()">Freigeben</button>
    </div>
  </div>
</div>

<!-- BOOK MODAL (Parent + Player) -->
<div id="bookModal" class="modalWrap">
  <div class="modal">
    <div class="modalHead">
      <b id="bookTitle">Slot buchen</b>
      <button class="x" onclick="closeBook()">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="small" id="bookInfo"></div>
      <div style="margin-top:12px">
        <label class="small"><b>Typ</b></label>
        <select id="bookType" class="input" style="margin-top:6px"></select>
      </div>
      <div style="margin-top:12px">
        <label class="small"><b>Notiz</b></label>
        <input id="bookNote" class="input" style="margin-top:6px" placeholder="Optional‚Ä¶">
      </div>
    </div>
    <div class="modalActions">
      <button class="btn" onclick="closeBook()">Abbrechen</button>
      <button class="btn ok" onclick="confirmBooking()">‚úÖ Buchen</button>
    </div>
  </div>
</div>

<!-- WALLET MODAL -->
<div id="walletModal" class="modalWrap">
  <div class="modal">
    <div class="modalHead">
      <b id="walletTitle">üß° SmartGen Wallet</b>
      <button class="x" onclick="closeWallet()">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="idCard">
        <div class="idTop">
          <div>
            <div class="idName" id="walletName">SmartGen</div>
            <div class="idSub" id="walletSub">Wallet/NFC ‚Ä¢ Demo</div>
          </div>
          <div class="nfcPill">üì∂ NFC aktiv</div>
        </div>

        <div class="idGrid" id="walletGrid"></div>

        <div class="qr">
          <div class="qrBox" title="QR Demo"></div>
          <div style="flex:1;min-width:200px">
            <div style="font-weight:1000">Check-in / Zugang</div>
            <div class="small">QR scannen oder NFC tap (Demo).</div>
            <button class="btn primary" style="margin-top:10px" onclick="simulateNFC()">üì∂ NFC Tap simulieren</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modalActions">
      <button class="btn" onclick="closeWallet()">Schlie√üen</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   CONFIG
========================= */
const PARENT_PIN = "1234";

/* Kid training blocks (affects ONLY Parent-Fitness) */
const kidTrainings = [
  { day: 3, start: "18:00", end: "19:30", label: "Kindertraining (Mi 18:00‚Äì19:30)" },
  { day: 5, start: "17:30", end: "19:00", label: "Kindertraining (Fr 17:30‚Äì19:00)" },
  { day: 6, start: "10:00", end: "11:30", label: "Kindertraining (Sa 10:00‚Äì11:30)" },
];

/* Parent fitness slots */
const fitnessSlotsCatalog = [
  { id:"mon_0900", day:1, start:"09:00", end:"10:00", title:"Eltern Fitness", desc:"Kraft ‚Ä¢ Core" },
  { id:"mon_1100", day:1, start:"11:00", end:"12:00", title:"Eltern Fitness", desc:"Cardio ‚Ä¢ Intervall" },
  { id:"tue_0930", day:2, start:"09:30", end:"10:30", title:"Mobility", desc:"Beweglichkeit ‚Ä¢ R√ºcken" },
  { id:"wed_1700", day:3, start:"17:00", end:"18:00", title:"Eltern Fitness", desc:"Kraft ‚Ä¢ Basics" },
  { id:"wed_1830", day:3, start:"18:30", end:"19:30", title:"Eltern Fitness", desc:"Cardio ‚Ä¢ HIIT" },
  { id:"fri_0900", day:5, start:"09:00", end:"10:00", title:"Regeneration", desc:"Stretch ‚Ä¢ Atmung" },
  { id:"fri_1800", day:5, start:"18:00", end:"19:00", title:"Eltern Fitness", desc:"Kraft ‚Ä¢ Mix" },
  { id:"sat_1830", day:6, start:"18:30", end:"19:30", title:"Eltern Fitness", desc:"Abend Slot" },
];

/* Player slots (separate, bookable) */
const playerSlotsCatalog = [
  { id:"p_tue_1700", day:2, start:"17:00", end:"18:00", title:"Privattraining", desc:"Technik ‚Ä¢ erster Kontakt" },
  { id:"p_thu_1830", day:4, start:"18:30", end:"19:30", title:"Kognitives Training", desc:"Scanning ‚Ä¢ Reaktion" },
  { id:"p_fri_1800", day:5, start:"18:00", end:"19:00", title:"Matchanalyse", desc:"KPIs ‚Ä¢ Video Hinweise" },
  { id:"p_sat_1200", day:6, start:"12:00", end:"13:00", title:"Athletik", desc:"Schnelligkeit ‚Ä¢ Core" },
];

const KEY_PARENT_BOOK = "sg_parent_bookings_v2";
const KEY_PLAYER_BOOK = "sg_player_bookings_v1";

let mode = "player";
let bookingContext = null; // { kind:'parent'|'player', slotId }
let walletMode = "player";

/* =========================
   HELPERS
========================= */
function $(id){ return document.getElementById(id); }
function toast(msg){
  const t = $("toast");
  t.innerHTML = msg;
  t.style.display = "block";
  clearTimeout(window.__to);
  window.__to = setTimeout(()=> t.style.display="none", 2600);
}
function dayName(d){ return ["So","Mo","Di","Mi","Do","Fr","Sa"][d]; }
function toMin(hhmm){ const [h,m]=hhmm.split(":").map(Number); return h*60+m; }
function overlaps(aStart,aEnd,bStart,bEnd){ return Math.max(aStart,bStart) < Math.min(aEnd,bEnd); }

function setStatusUI(text){
  $("statusText").textContent = text;
  const dot = $("statusDot");
  dot.style.background = (text==="Aktiv") ? "var(--ok)" : (text==="Pause") ? "var(--warn)" : "var(--danger)";
  dot.style.boxShadow = (text==="Aktiv")
    ? "0 0 0 6px rgba(37,208,127,.10)"
    : (text==="Pause")
      ? "0 0 0 6px rgba(255,176,32,.10)"
      : "0 0 0 6px rgba(255,77,77,.10)";
}

function loadBookings(key){
  const raw = localStorage.getItem(key);
  return raw ? JSON.parse(raw) : [];
}
function saveBookings(key, list){
  localStorage.setItem(key, JSON.stringify(list));
}
function isBooked(key, slotId){
  return loadBookings(key).some(b => b.slotId === slotId);
}

/* =========================
   MODE
========================= */
function setMode(next){
  mode = next;
  document.body.classList.toggle("parent", mode==="parent");
  $("modeLabel").textContent = "Modus: " + (mode==="parent" ? "Eltern (Orange Neon)" : "Spieler");

  $("playerDash").classList.toggle("hidden", mode !== "player");
  $("parentDash").classList.toggle("hidden", mode !== "parent");
  $("fitnessCard").classList.toggle("hidden", mode !== "parent");
  $("parentHint").classList.toggle("hidden", mode === "parent");

  if(mode === "parent"){
    renderFitness();
    $("pStatusTag").textContent = "Aktiv";
  }else{
    renderPlayerSlots();
  }
  setStatusUI("Aktiv");
}

/* =========================
   PIN
========================= */
function openPin(){
  $("pinModal").style.display = "flex";
  $("pinInput").value = "";
  $("pinInput").focus();
}
function closePin(){ $("pinModal").style.display = "none"; }
function checkPin(){
  const pin = $("pinInput").value.trim();
  if(pin === PARENT_PIN){
    closePin();
    setMode("parent");
    toast("‚úÖ <b>Eltern-Freigabe aktiv</b>");
  } else {
    toast("‚ùå <b>Falscher PIN</b><br>Bitte erneut versuchen.");
  }
}

/* =========================
   PARENT FITNESS (blocked by kid training)
========================= */
function isBlockedByKidTraining(slot){
  const sA = toMin(slot.start), sB = toMin(slot.end);
  const blocks = kidTrainings.filter(k=>k.day === slot.day);
  for(const k of blocks){
    const kA = toMin(k.start), kB = toMin(k.end);
    if(overlaps(sA,sB,kA,kB)) return {blocked:true, reason:k.label};
  }
  return {blocked:false, reason:""};
}

function renderFitness(){
  const list = $("fitnessSlots");
  list.innerHTML = "";

  const bookings = loadBookings(KEY_PARENT_BOOK);
  $("bookCount").textContent = bookings.length;

  const sorted = [...fitnessSlotsCatalog].sort((a,b)=>{
    if(a.day !== b.day) return a.day - b.day;
    return toMin(a.start) - toMin(b.start);
  });

  for(const slot of sorted){
    const blockInfo = isBlockedByKidTraining(slot);
    const booked = isBooked(KEY_PARENT_BOOK, slot.id);

    const div = document.createElement("div");
    div.className = "slot";

    const statusTag = blockInfo.blocked
      ? `<span class="tag danger">Gesperrt</span>`
      : booked
        ? `<span class="tag ok">Gebucht</span>`
        : `<span class="tag warn">Frei</span>`;

    const actionBtn = blockInfo.blocked
      ? `<button class="btn" disabled>‚õî</button>`
      : booked
        ? `<button class="btn ghost" onclick="cancelBooking('parent','${slot.id}')">Storno</button>`
        : `<button class="btn ok" onclick="openBook('parent','${slot.id}')">Buchen</button>`;

    div.innerHTML = `
      <div>
        <strong>${dayName(slot.day)} ‚Ä¢ ${slot.start}‚Äì${slot.end} ‚Äî ${slot.title}</strong>
        <small>${slot.desc}${blockInfo.blocked ? " ‚Ä¢ <b>Block:</b> "+blockInfo.reason : ""}</small>
      </div>
      <div class="right">
        ${statusTag}
        ${actionBtn}
      </div>
    `;
    list.appendChild(div);
  }
}

/* =========================
   PLAYER SLOTS (bookable)
========================= */
function renderPlayerSlots(){
  const list = $("playerSlots");
  list.innerHTML = "";

  const sorted = [...playerSlotsCatalog].sort((a,b)=>{
    if(a.day !== b.day) return a.day - b.day;
    return toMin(a.start) - toMin(b.start);
  });

  for(const slot of sorted){
    const booked = isBooked(KEY_PLAYER_BOOK, slot.id);

    const div = document.createElement("div");
    div.className = "slot";

    const statusTag = booked ? `<span class="tag ok">Gebucht</span>` : `<span class="tag warn">Frei</span>`;
    const actionBtn = booked
      ? `<button class="btn ghost" onclick="cancelBooking('player','${slot.id}')">Storno</button>`
      : `<button class="btn ok" onclick="openBook('player','${slot.id}')">Buchen</button>`;

    div.innerHTML = `
      <div>
        <strong>${dayName(slot.day)} ‚Ä¢ ${slot.start}‚Äì${slot.end} ‚Äî ${slot.title}</strong>
        <small>${slot.desc}</small>
      </div>
      <div class="right">
        ${statusTag}
        ${actionBtn}
      </div>
    `;
    list.appendChild(div);
  }
}

/* =========================
   BOOK MODAL (shared)
========================= */
function openBook(kind, slotId){
  bookingContext = { kind, slotId };

  const isParent = kind === "parent";
  const catalog = isParent ? fitnessSlotsCatalog : playerSlotsCatalog;
  const slot = catalog.find(s=>s.id===slotId);
  if(!slot) return;

  if(isParent){
    const blockInfo = isBlockedByKidTraining(slot);
    if(blockInfo.blocked){
      toast("‚õî <b>Gesperrt</b><br>Dieser Slot kollidiert mit Kindertraining.");
      bookingContext = null;
      return;
    }
    if(isBooked(KEY_PARENT_BOOK, slotId)){
      toast("‚úÖ <b>Schon gebucht</b>");
      bookingContext = null;
      return;
    }
  } else {
    if(isBooked(KEY_PLAYER_BOOK, slotId)){
      toast("‚úÖ <b>Schon gebucht</b>");
      bookingContext = null;
      return;
    }
  }

  $("bookTitle").textContent = `${isParent ? "Eltern" : "Spieler"} Slot buchen: ${dayName(slot.day)} ${slot.start}‚Äì${slot.end}`;
  $("bookInfo").innerHTML = `<b>${slot.title}</b> ‚Äì ${slot.desc}`;

  const sel = $("bookType");
  sel.innerHTML = "";
  const options = isParent
    ? ["Eltern Fitness ‚Äì Kraft","Eltern Fitness ‚Äì Cardio","Mobility / R√ºcken","Regeneration / Stretching"]
    : ["Privattraining (Technik)","Kognitives Training","Athletik","Matchanalyse"];
  options.forEach(o=>{
    const opt = document.createElement("option");
    opt.textContent = o;
    sel.appendChild(opt);
  });

  $("bookNote").value = "";
  $("bookModal").style.display = "flex";
}
function closeBook(){
  $("bookModal").style.display = "none";
  bookingContext = null;
}
function confirmBooking(){
  if(!bookingContext) return;
  const { kind, slotId } = bookingContext;
  const isParent = kind === "parent";
  const catalog = isParent ? fitnessSlotsCatalog : playerSlotsCatalog;
  const slot = catalog.find(s=>s.id===slotId);
  if(!slot) return;

  const type = $("bookType").value;
  const note = $("bookNote").value.trim();

  const key = isParent ? KEY_PARENT_BOOK : KEY_PLAYER_BOOK;
  const bookings = loadBookings(key);
  bookings.push({ slotId, createdAt:new Date().toISOString(), type, note });
  saveBookings(key, bookings);

  closeBook();

  if(isParent) renderFitness();
  else renderPlayerSlots();

  toast(`‚úÖ <b>Buchung best√§tigt</b><br>${dayName(slot.day)} ${slot.start}‚Äì${slot.end} ‚Ä¢ ${type}${note? "<br><span class='small'>Notiz: "+note+"</span>":""}`);
}

function cancelBooking(kind, slotId){
  const isParent = kind === "parent";
  const key = isParent ? KEY_PARENT_BOOK : KEY_PLAYER_BOOK;
  const catalog = isParent ? fitnessSlotsCatalog : playerSlotsCatalog;
  const slot = catalog.find(s=>s.id===slotId);

  const bookings = loadBookings(key).filter(b => b.slotId !== slotId);
  saveBookings(key, bookings);

  if(isParent) renderFitness();
  else renderPlayerSlots();

  toast(`üóëÔ∏è <b>Storniert</b><br>${slot ? (dayName(slot.day)+" "+slot.start+"‚Äì"+slot.end) : "Slot"} entfernt.`);
}

/* =========================
   RESET PARENT
========================= */
function resetParentBookings(){
  localStorage.removeItem(KEY_PARENT_BOOK);
  renderFitness();
  toast("üßπ <b>Reset</b><br>Alle Eltern-Buchungen gel√∂scht.");
}

/* =========================
   WALLET / NFC
========================= */
function openWallet(kind){
  walletMode = kind;
  $("walletModal").style.display="flex";

  if(kind === "player"){
    $("walletTitle").textContent = "‚öΩ Spieler Wallet / NFC";
    $("walletName").textContent = "Spieler-ID ‚Ä¢ SmartGen";
    $("walletSub").textContent = "Orange NFC ‚Ä¢ Check-in (Demo)";
    $("walletGrid").innerHTML = `
      <div class="kv"><b>Spieler</b><span>Amine B.</span></div>
      <div class="kv"><b>Team</b><span>U15</span></div>
      <div class="kv"><b>Level</b><span>Fortgeschritten</span></div>
      <div class="kv"><b>Status</b><span>Aktiv</span></div>
    `;
  } else {
    $("walletTitle").textContent = "üß° Eltern Wallet / NFC";
    $("walletName").textContent = "Eltern-ID ‚Ä¢ SmartGen";
    $("walletSub").textContent = "Orange Neon Edition (Demo)";
    $("walletGrid").innerHTML = `
      <div class="kv"><b>Elternteil</b><span>Parent One</span></div>
      <div class="kv"><b>Kind</b><span>Amine B.</span></div>
      <div class="kv"><b>Vertrag</b><span>Premium</span></div>
      <div class="kv"><b>Status</b><span>Aktiv</span></div>
    `;
  }
}
function closeWallet(){ $("walletModal").style.display="none"; }
function simulateNFC(){
  toast(`üì∂ <b>NFC Tap OK</b><br>${walletMode==="player" ? "Spieler" : "Eltern"} Check-in registriert (Demo).`);
}

/* init */
setStatusUI("Aktiv");
setMode("player");
renderPlayerSlots();
</script>
</body>
</html>
