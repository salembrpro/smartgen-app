<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SmartGen ‚Äì Spieler & Eltern Dashboard</title>

<style>
:root{
  --bg:#070a10;
  --text:#eaf2ff;
  --muted:#a7b6cf;
  --line:rgba(255,255,255,.12);

  --accent:#ff7a18;
  --accent2:#ffb14a;

  --ok:#25d07f;
  --warn:#ffb020;
  --danger:#ff4d4d;

  --radius:20px;
  --shadow: 0 26px 80px rgba(0,0,0,.55);
  --shadow2: 0 14px 36px rgba(0,0,0,.35);

  --cardA: rgba(16,24,36,.78);
  --cardB: rgba(10,14,22,.70);

  --pGlow: 0 0 0 1px rgba(255,122,24,.26), 0 0 55px rgba(255,122,24,.18);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color:var(--text);
  background:#070a10;
  overflow-x:hidden;
}
/* =========================
   KIDS + TEENS FRIENDLY TABS
   ========================= */

.tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 14px;
  margin: 18px 0 24px;
}

.tab {
  display: flex;
  align-items: center;
  gap: 12px;

  padding: 16px 22px;
  min-height: 58px;

  font-size: 18px;
  font-weight: 700;

  color: #ffffff;
  background: linear-gradient(
    180deg,
    rgba(25,32,48,.95),
    rgba(12,16,26,.95)
  );

  border-radius: 999px;
  border: 2px solid rgba(255,122,24,.35);

  box-shadow:
    0 0 0 1px rgba(255,122,24,.25),
    0 0 30px rgba(255,122,24,.18);

  cursor: pointer;
  transition: all .2s ease;
}

/* ICON GROSS + KLAR */
.tab .icon {
  font-size: 26px;
}

/* ACTIVE TAB */
.tab.active {
  background: linear-gradient(
    180deg,
    rgba(255,122,24,.95),
    rgba(255,177,74,.95)
  );
  color: #000;
  box-shadow: 0 0 40px rgba(255,122,24,.55);
}

/* HOVER */
.tab:hover {
  transform: translateY(-2px) scale(1.03);
  box-shadow: 0 0 45px rgba(255,122,24,.45);
}
/* BACKGROUND (Carbon + Hex) */
.bg{
  position:fixed; inset:0; z-index:-2;
  background:
    radial-gradient(900px 420px at 14% -10%, rgba(255,122,24,.14), transparent 62%),
    radial-gradient(900px 420px at 100% 10%, rgba(255,122,24,.08), transparent 64%),
    radial-gradient(900px 420px at 55% 115%, rgba(255,255,255,.06), transparent 60%),
    linear-gradient(180deg, #070a10 0%, #0b1323 55%, #070a10 100%);
}
.bg::before{
  content:"";
  position:absolute; inset:0;
  opacity:.55;
  background:
    linear-gradient(135deg, rgba(255,255,255,.05) 0 6px, rgba(0,0,0,0) 6px 12px),
    linear-gradient(315deg, rgba(255,255,255,.035) 0 6px, rgba(0,0,0,0) 6px 12px);
  background-size: 22px 22px;
  mix-blend-mode: overlay;
  filter: contrast(1.1);
}
.bg::before{
  content:"";
  position:absolute; inset:0;

  /* BIG CARBON (gr√∂√üere Struktur) + leichter Orange-Touch */
  opacity:.55;
  background:
    /* Orange Glow */
    radial-gradient(900px 500px at 20% 0%, rgba(255,122,24,.18), transparent 62%),

    /* Carbon Web (gr√∂√üer) */
    linear-gradient(135deg, rgba(255,255,255,.06) 0 10px, rgba(0,0,0,0) 10px 22px),
    linear-gradient(315deg, rgba(255,255,255,.045) 0 10px, rgba(0,0,0,0) 10px 22px);

  /* HIER macht‚Äôs ‚Äûgrosse Carbon‚Äú-Form */
  background-size: 60px 60px, 60px 60px, 60px 60px;

  mix-blend-mode: overlay;
  filter: contrast(1.2) saturate(1.15);
}

/* Parent Mode Overlay (more orange neon) */
.parentFX{
  position:fixed; inset:0; z-index:-1;
  opacity:0; pointer-events:none;
  transition: opacity .25s ease;
  background:
    radial-gradient(900px 500px at 18% 0%, rgba(255,122,24,.22), transparent 62%),
    radial-gradient(900px 500px at 90% 20%, rgba(255,122,24,.14), transparent 62%),
    radial-gradient(900px 500px at 50% 120%, rgba(255,177,74,.10), transparent 65%);
}
body.parent .parentFX{ opacity:1; }

.wrap{max-width:1140px;margin:auto;padding:18px 14px 26px}
.grid{display:grid;grid-template-columns:1.05fr .95fr;gap:14px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}

.card{
  border:1px solid var(--line);
  border-radius: var(--radius);
  background: linear-gradient(180deg, rgba(16,24,36,.78), rgba(10,14,22,.70));
  box-shadow: var(--shadow);
  overflow:hidden;
}
.cardPad{padding:16px}
.hidden{display:none}

h2{margin:0 0 10px 0;font-size:18px;letter-spacing:.2px}
h3{margin:0 0 8px 0;font-size:15px;letter-spacing:.2px}
.small{color:var(--muted);font-size:13px;line-height:1.45}
.hr{border:none;border-top:1px solid var(--line); margin:12px 0}

/* TOP */
.top{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px;
  padding:14px 16px;
  border-bottom:1px solid var(--line);
  background:
    radial-gradient(700px 220px at 10% 0%, rgba(255,122,24,.20), transparent 60%),
    radial-gradient(700px 220px at 90% 10%, rgba(255,122,24,.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.04), transparent);
}
.brand{display:flex; align-items:center; gap:12px;}
.logoDot{
  width:46px; height:46px; border-radius:18px;
  background:
    radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), transparent 55%),
    linear-gradient(135deg, rgba(255,122,24,.95), rgba(255,177,74,.45));
  box-shadow: 0 0 0 1px rgba(255,255,255,.10), 0 18px 55px rgba(255,122,24,.18);
}
.brandTitle{font-weight:1000; letter-spacing:.2px}
.pills{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
.pill{
  display:inline-flex; align-items:center; gap:10px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.22);
  box-shadow: var(--shadow2);
  font-weight:1000;
  font-size:14px;
}
.dot{
  width:11px;height:11px;border-radius:50%;
  background: var(--ok);
  box-shadow: 0 0 0 6px rgba(37,208,127,.10);
}

/* BUTTONS */
.btn{
  padding:13px 14px;
  border-radius:16px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.22);
  color: var(--text);
  font-weight:1000;
  cursor:pointer;
  font-size:15px;
}
.btn:active{transform:translateY(1px)}
.btn.primary{
  border-color: rgba(255,122,24,.75);
  background: linear-gradient(135deg, rgba(255,122,24,.22), rgba(255,255,255,.02));
  box-shadow: 0 18px 55px rgba(255,122,24,.12);
}
body.parent .btn.primary{ box-shadow: var(--pGlow); }
.btn.ok{
  border-color: rgba(37,208,127,.55);
  background: rgba(37,208,127,.12);
}
.btn.ghost{background: rgba(255,255,255,.06)}
.btn:disabled{opacity:.45; cursor:not-allowed}

/* Tabs */
.tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
.tab{
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.18);
  cursor:pointer;
  font-weight:1000;
  font-size:14px;
}
.tab.active{
  border-color: rgba(255,122,24,.60);
  background: rgba(255,122,24,.12);
  box-shadow: 0 14px 40px rgba(255,122,24,.10);
}

/* TAGS */
.tag{
  padding:8px 12px;
  border-radius:999px;
  font-size:13px;
  font-weight:1000;
  background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.10);
  white-space:nowrap;
}
.tag.ok{background: rgba(37,208,127,.14); border-color: rgba(37,208,127,.35)}
.tag.warn{background: rgba(255,176,32,.14); border-color: rgba(255,176,32,.35)}
.tag.danger{background: rgba(255,77,77,.14); border-color: rgba(255,77,77,.35)}

/* LIST */
.list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.slot{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:13px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
}
.slot strong{font-size:15px; font-weight:1000}
.slot small{display:block;color:var(--muted);margin-top:4px;font-size:13px}
.slot .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}

/* Wallet / NFC Card Button */
.walletBtn{
  width:100%;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:14px;
  border-radius:18px;
  border:1px solid rgba(255,122,24,.35);
  background: linear-gradient(135deg, rgba(255,122,24,.14), rgba(0,0,0,.20));
  cursor:pointer;
  font-weight:1000;
}
.walletBtn:hover{border-color: rgba(255,122,24,.55)}
.walletBtn .left{display:flex;align-items:center;gap:12px}
.walletBtn .ic{font-size:28px}
.walletBtn .right{opacity:.9; font-size:18px}

/* Inputs */
.input{
  padding:14px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(0,0,0,.22);
  color: var(--text);
  width:100%;
  font-size:15px;
  outline:none;
}
select.input{appearance:none}

/* MODALS */
.modalWrap{
  position:fixed; inset:0;
  background:rgba(0,0,0,.62);
  display:none;
  align-items:center; justify-content:center;
  padding:16px; z-index:50;
}
.modal{
  width:min(720px, 100%);
  background: linear-gradient(180deg, rgba(16,24,36,.94), rgba(10,14,22,.92));
  border:1px solid var(--line);
  border-radius:20px;
  overflow:hidden;
  box-shadow: 0 36px 120px rgba(0,0,0,.65);
}
.modalHead{
  padding:14px 16px;
  border-bottom:1px solid var(--line);
  display:flex; align-items:center; justify-content:space-between;
  background:
    radial-gradient(700px 220px at 15% 0%, rgba(255,122,24,.18), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.04), transparent);
}
.modalHead b{font-size:15px}
.x{
  width:46px;height:46px;border-radius:16px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.22);
  color:white;
  cursor:pointer;
  font-weight:1000;
  font-size:16px;
}
.modalBody{padding:16px}
.modalActions{
  padding:14px 16px;
  border-top:1px solid var(--line);
  display:flex; gap:10px; justify-content:flex-end;
}

/* Wallet card */
.idCard{
  border-radius:22px;
  border:1px solid rgba(255,122,24,.40);
  background:
    radial-gradient(420px 240px at 20% 0%, rgba(255,122,24,.26), transparent 60%),
    radial-gradient(420px 240px at 90% 40%, rgba(255,177,74,.14), transparent 62%),
    linear-gradient(135deg, rgba(0,0,0,.25), rgba(255,255,255,.03));
  padding:16px;
  box-shadow: var(--pGlow);
}
.idTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
.idName{font-weight:1000;font-size:16px}
.idSub{color:rgba(255,230,210,.85);font-weight:900;font-size:12px}
.idGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  margin-top:12px;
}
.kv{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
  border-radius:14px;
  padding:10px;
}
.kv b{display:block;font-size:12px}
.kv span{color:rgba(255,255,255,.90);font-weight:1000}
.qr{
  margin-top:12px;
  display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
}
.qrBox{
  width:120px;height:120px;border-radius:18px;
  border:1px solid rgba(255,255,255,.14);
  background:
    repeating-linear-gradient(0deg, rgba(255,255,255,.16) 0 6px, rgba(0,0,0,.0) 6px 12px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.10) 0 6px, rgba(0,0,0,.0) 6px 12px);
  opacity:.9;
}
.nfcPill{
  display:inline-flex; align-items:center; gap:10px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,122,24,.45);
  background: rgba(255,122,24,.12);
  font-weight:1000;
}

/* Donuts */
.donutRow{display:flex; gap:12px; flex-wrap:wrap; margin-top:10px}
.donut{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
  border-radius:18px;
  padding:12px;
  min-width:160px;
  flex:1;
}
.donutTop{display:flex;justify-content:space-between;align-items:center}
.donutTop b{font-size:13px}
.donutVal{font-weight:1000}

/* Charts */
.chartCard{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
  border-radius:18px;
  padding:12px;
  margin-top:10px;
}
canvas{width:100%; height:auto; display:block}

/* Weekly bars */
.weekRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
.weekBox{
  flex:1;
  min-width:160px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
  border-radius:18px;
  padding:12px;
}
.bar{
  height:14px;
  border-radius:999px;
  background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.12);
  overflow:hidden;
  margin-top:8px;
}
.barFill{
  height:100%;
  width:0%;
  background: linear-gradient(90deg, rgba(255,122,24,.85), rgba(255,177,74,.55));
}

/* Calendar */
.calHead{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
.calGrid{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap:8px;
}
.dayBox{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
  border-radius:16px;
  padding:10px;
  min-height:110px;
}
.dayName{font-weight:1000; font-size:13px}
.event{
  margin-top:8px;
  padding:8px 10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  font-size:12px;
}
.event.orange{
  border-color: rgba(255,122,24,.30);
  background: rgba(255,122,24,.10);
}

/* TOAST */
.toast{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  background: rgba(16,24,36,.94);
  border:1px solid var(--line);
  border-radius:18px;
  padding:12px 14px;
  display:none;
  z-index:60;
  font-size:14px;
  color:var(--muted);
  box-shadow: 0 18px 60px rgba(0,0,0,.55);
}
.toast b{color:var(--text)}
</style>
</head>

<body>
<div class="bg"></div>
<div class="parentFX"></div>

<div class="wrap">

  <!-- HEADER -->
  <div class="card">
    <div class="top">
      <div class="brand">
        <div class="logoDot"></div>
        <div>
          <div class="brandTitle">SmartGen Fussball Akademie</div>
          <div class="small" id="modeLabel">Modus: Spieler</div>
        </div>
      </div>

      <div class="pills">
        <div class="pill" title="Status">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">Aktiv</span>
        </div>
        <button class="btn primary" onclick="setMode('player')">‚öΩ Spieler</button>
        <button class="btn" onclick="openPin()">üë®‚Äçüë©‚Äçüë¶ Eltern</button>
      </div>
    </div>

    <div class="cardPad">
      <div class="small">
        <b>Neu:</b> Spieler-Analyse (Sessions + Score-Chart + Anwesenheit/Woche) ‚Ä¢ Ern√§hrung im Spieler-Modus ‚Ä¢ Eltern-Kommunikation mit Trainer-Auswahl.
      </div>
    </div>
  </div>

  <div class="grid">

    <!-- LEFT -->
    <div>

      <!-- PLAYER -->
      <div id="playerDash" class="card">
        <div class="cardPad">
          <h2>‚öΩ Spieler Dashboard</h2>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0">
            <span class="tag ok" id="pMetaTag">U15 ‚Ä¢ Technik & Kognition</span>
            <span class="tag ok" id="pStatusTag">Aktiv</span>
            <span class="tag warn" id="pTrainerTag">Trainer: Salem</span>
          </div>

          <div class="tabs">
            <button class="tab active" id="tabP_Analyse" onclick="showTab('player','Analyse')">üìä Analyse</button>
            <button class="tab" id="tabP_Kalender" onclick="showTab('player','Kalender')">üóìÔ∏è Kalender</button>
            <button class="tab" id="tabP_Slots" onclick="showTab('player','Slots')">‚è±Ô∏è Slots</button>
            <button class="tab" id="tabP_Ernaehrung" onclick="showTab('player','Ernaehrung')">ü•ó Ern√§hrung</button>
            <button class="tab" id="tabP_Daten" onclick="showTab('player','Daten')">üë§ Daten</button>
          </div>

          <!-- Player: Analyse -->
          <div id="player_Analyse">
            <button class="walletBtn" onclick="openWallet('player')">
              <div class="left">
                <span class="ic">‚öΩ</span>
                <div>
                  <div style="font-weight:1000">SmartGen Spieler-ID (Wallet/NFC)</div>
                  <div class="small">Tap & Check-in ‚Ä¢ QR ‚Ä¢ Zugang</div>
                </div>
              </div>
              <div class="right">‚Ä∫</div>
            </button>

            <!-- Donuts -->
            <div class="donutRow">
              <div class="donut">
                <div class="donutTop"><b>Anwesenheit</b><span class="donutVal" id="d_att">--%</span></div>
                <svg width="140" height="90" viewBox="0 0 140 90">
                  <path d="M20,70 A50,50 0 1 1 120,70" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="12" stroke-linecap="round"></path>
                  <path id="arc_att" d="M20,70 A50,50 0 1 1 120,70" fill="none" stroke="var(--accent)" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 999"></path>
                </svg>
                <div class="small">letzte 30 Tage</div>
              </div>

              <div class="donut">
                <div class="donutTop"><b>Progress</b><span class="donutVal" id="d_prog">--%</span></div>
                <svg width="140" height="90" viewBox="0 0 140 90">
                  <path d="M20,70 A50,50 0 1 1 120,70" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="12" stroke-linecap="round"></path>
                  <path id="arc_prog" d="M20,70 A50,50 0 1 1 120,70" fill="none" stroke="var(--accent)" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 999"></path>
                </svg>
                <div class="small">Skill-Level</div>
              </div>

              <div class="donut">
                <div class="donutTop"><b>Performance</b><span class="donutVal" id="d_perf">--/100</span></div>
                <svg width="140" height="90" viewBox="0 0 140 90">
                  <path d="M20,70 A50,50 0 1 1 120,70" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="12" stroke-linecap="round"></path>
                  <path id="arc_perf" d="M20,70 A50,50 0 1 1 120,70" fill="none" stroke="var(--accent)" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 999"></path>
                </svg>
                <div class="small">Score (Demo)</div>
              </div>
            </div>

            <!-- Score Chart + Weekly Attendance -->
            <div class="chartCard">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
                <div>
                  <h3 style="margin:0">üìà Score Verlauf</h3>
                  <div class="small">Letzte 10 Sessions (Score 0‚Äì100)</div>
                </div>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                  <button class="btn ghost" onclick="markToday(true)">Heute anwesend ‚úÖ</button>
                  <button class="btn ghost" onclick="markToday(false)">Heute gefehlt ‚ùå</button>
                </div>
              </div>
              <canvas id="scoreChart" width="900" height="260"></canvas>
            </div>

            <div class="weekRow">
              <div class="weekBox">
                <b>üìÖ Anwesenheit Woche A</b>
                <div class="small">letzte 7 Tage (Demo)</div>
                <div class="bar"><div class="barFill" id="wkA"></div></div>
              </div>
              <div class="weekBox">
                <b>üìÖ Anwesenheit Woche B</b>
                <div class="small">Woche davor (Demo)</div>
                <div class="bar"><div class="barFill" id="wkB"></div></div>
              </div>
              <div class="weekBox">
                <b>üìÖ Anwesenheit Woche C</b>
                <div class="small">Woche davor (Demo)</div>
                <div class="bar"><div class="barFill" id="wkC"></div></div>
              </div>
            </div>

            <!-- Session list -->
            <div class="hr"></div>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
              <h3 style="margin:0">üßæ Session-Liste</h3>
              <button class="btn primary" onclick="addRandomSession()">Ôºã Demo Session</button>
            </div>
            <div class="list" id="sessionList"></div>

          </div>

          <!-- Player: Kalender -->
          <div id="player_Kalender" class="hidden">
            <div class="calHead">
              <div>
                <h3 style="margin:0">üóìÔ∏è Kalender (Woche)</h3>
                <div class="small">Events sind Demo ‚Äì speichern lokal.</div>
              </div>
              <button class="btn primary" onclick="openEventModal('player')">Ôºã Event</button>
            </div>
            <div class="calGrid" id="calPlayer"></div>
          </div>

          <!-- Player: Slots -->
          <div id="player_Slots" class="hidden">
            <h3>üéõÔ∏è Training ausw√§hlen</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn" onclick="setCategory('Technik')">‚öΩ Technik</button>
              <button class="btn" onclick="setCategory('Athletik')">üèÉ Athletik</button>
              <button class="btn" onclick="setCategory('Kognition')">üß† Kognition</button>
            </div>
            <div class="small" style="margin-top:10px">Kategorie: <b id="playerCat">Technik</b></div>
            <div class="list" id="playerSlots"></div>
          </div>

          <!-- Player: Ern√§hrung (moved here) -->
          <div id="player_Ernaehrung" class="hidden">
            <h3>ü•ó Ern√§hrung (Spieler)</h3>
            <div class="small">Einfacher Tagesplan + Snack + Wasser. (Demo, lokal)</div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
              <select class="input" id="p_nutri_style">
                <option value="sport">Sport-Performance</option>
                <option value="familie">Familien-Style (einfach)</option>
                <option value="low">Leicht & gesund</option>
              </select>
              <select class="input" id="p_nutri_allergy">
                <option value="none">Keine Allergie</option>
                <option value="laktose">Laktosefrei</option>
                <option value="nuesse">Ohne N√ºsse</option>
                <option value="gluten">Glutenfrei</option>
              </select>
            </div>

            <button class="btn primary" style="width:100%; margin-top:10px" onclick="genPlayerNutrition()">üçΩÔ∏è Plan erstellen</button>

            <div class="slot" style="margin-top:10px">
              <div>
                <strong>Plan</strong>
                <small id="p_nutri_plan">Fr√ºhst√ºck ‚Ä¢ Mittag ‚Ä¢ Abend ‚Ä¢ Snack ‚Ä¢ Wasser</small>
              </div>
              <div class="right"><span class="tag warn">KI</span></div>
            </div>

            <div class="hr"></div>
            <h3>üß† Mini Motivation (Spieler)</h3>
            <div class="small">Kurzer Satz vor Training.</div>
            <button class="btn ghost" style="width:100%;margin-top:10px" onclick="genPlayerMotivation()">üî• Motivation</button>
            <div class="slot" style="margin-top:10px">
              <div>
                <strong>Heute</strong>
                <small id="p_motivation">‚ÄûHeute bist du schneller als gestern.‚Äú</small>
              </div>
              <div class="right"><span class="tag ok">KI</span></div>
            </div>
          </div>

          <!-- Player: Daten -->
          <div id="player_Daten" class="hidden">
            <h3>üë§ Pers√∂nliche Daten</h3>
            <div class="list">
              <div class="slot">
                <div><strong>Name</strong><small id="pd_name">Amine B.</small></div>
                <div class="right"><span class="tag ok">Mitglied</span></div>
              </div>
              <div class="slot">
                <div><strong>Geburtsjahr</strong><small id="pd_year">2012</small></div>
                <div class="right"><span class="tag">U15</span></div>
              </div>
              <div class="slot">
                <div><strong>Vertrag</strong><small id="pd_contract">Premium ‚Ä¢ Laufend</small></div>
                <div class="right"><span class="tag warn">Abo</span></div>
              </div>
              <div class="slot">
                <div><strong>Notfall Kontakt</strong><small id="pd_emg">Parent One ‚Ä¢ +49 ‚Ä¶</small></div>
                <div class="right"><span class="tag">Info</span></div>
              </div>
            </div>
            <div class="hr"></div>
            <button class="btn primary" style="width:100%" onclick="toast('‚úÖ <b>Daten gespeichert</b><br>(Demo)')">Speichern (Demo)</button>
          </div>
        </div>
      </div>

      <!-- PARENT DASH (unchanged design, only communication upgraded) -->
      <div id="parentDash" class="hidden">
        <div class="card">
          <div class="cardPad">
            <h2>üë®‚Äçüë©‚Äçüë¶ Eltern Dashboard</h2>

            <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0">
              <span class="tag ok">Kind: Amine B.</span>
              <span class="tag ok">Vertrag: Premium</span>
              <span class="tag warn" id="parentTrainerTag">Trainer: Salem</span>
            </div>

            <div class="tabs">
              <button class="tab active" id="tabE_KI" onclick="showTab('parent','KI')">ü§ñ KI</button>
              <button class="tab" id="tabE_Kalender" onclick="showTab('parent','Kalender')">üóìÔ∏è Kalender</button>
              <button class="tab" id="tabE_Fitness" onclick="showTab('parent','Fitness')">üèãÔ∏è Fitness</button>
              <button class="tab" id="tabE_Daten" onclick="showTab('parent','Daten')">üë§ Daten</button>
            </div>

            <!-- Parent: KI (nutrition removed here) -->
            <div id="parent_KI">
              <button class="walletBtn" onclick="openWallet('parent')">
                <div class="left">
                  <span class="ic">üß°</span>
                  <div>
                    <div style="font-weight:1000">Eltern NFC / Wallet Karte</div>
                    <div class="small">Orange Edition ‚Ä¢ Tap & Check-in</div>
                  </div>
                </div>
                <div class="right">‚Ä∫</div>
              </button>

              <div class="hr"></div>

              <h3>üß† KI Motivation</h3>
              <div class="small">W√§hle Ziel + Mood ‚Äî SmartGen KI erstellt Satz (Demo).</div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
                <select class="input" id="ki_goal">
                  <option value="energie">Mehr Energie & Gesundheit</option>
                  <option value="kraft">Kraft & Muskelaufbau</option>
                  <option value="abnehmen">Fett reduzieren</option>
                  <option value="stress">Stress reduzieren</option>
                </select>
                <select class="input" id="ki_mood">
                  <option value="kurz">Kurz & stark</option>
                  <option value="coach">Coach-Style</option>
                  <option value="freundlich">Freundlich</option>
                </select>
              </div>

              <button class="btn primary" style="width:100%; margin-top:10px" onclick="genMotivation()">‚ö° Motivation generieren</button>
              <div class="slot" style="margin-top:10px">
                <div>
                  <strong>Heute</strong>
                  <small id="ki_motivation">‚ÄûBereit? Wir machen das smart.‚Äú</small>
                </div>
                <div class="right"><span class="tag ok">KI</span></div>
              </div>

              <div class="hr"></div>
              <div class="small"><b>Hinweis:</b> Ern√§hrung ist jetzt im Spieler-Dashboard.</div>
            </div>

            <!-- Parent: Kalender -->
            <div id="parent_Kalender" class="hidden">
              <div class="calHead">
                <div>
                  <h3 style="margin:0">üóìÔ∏è Eltern Kalender</h3>
                  <div class="small">Kindertraining + Eltern-Fitness Events sichtbar.</div>
                </div>
                <button class="btn primary" onclick="openEventModal('parent')">Ôºã Event</button>
              </div>
              <div class="calGrid" id="calParent"></div>
            </div>

            <!-- Parent: Fitness -->
            <div id="parent_Fitness" class="hidden">
              <h3>üèãÔ∏è Eltern-Fitness echt buchbar</h3>
              <div class="small">W√§hrend Kindertraining automatisch gesperrt.</div>
              <div class="list" id="fitnessSlots"></div>

              <div class="hr"></div>
              <div class="small"><b>Gebucht:</b> <span id="bookCount">0</span> Slot(s)</div>
              <button class="btn ghost" style="width:100%;margin-top:10px" onclick="resetParentBookings()">Reset (Demo)</button>
            </div>

            <!-- Parent: Daten + Kommunikation upgraded -->
            <div id="parent_Daten" class="hidden">
              <h3>üë§ Eltern Infos</h3>
              <div class="list">
                <div class="slot">
                  <div><strong>Elternteil</strong><small>Parent One</small></div>
                  <div class="right"><span class="tag ok">Aktiv</span></div>
                </div>
                <div class="slot">
                  <div><strong>Vertrag</strong><small>Premium ‚Ä¢ Laufend</small></div>
                  <div class="right"><span class="tag warn">Abo</span></div>
                </div>
              </div>

              <div class="hr"></div>
              <h3>üí¨ Kommunikation mit Trainer</h3>
              <div class="small">W√§hle Trainer, dann Nachricht senden (Demo).</div>

              <select class="input" id="parentTrainerSelect" style="margin-top:10px" onchange="parentSelectTrainer()">
                <option value="Salem">Salem</option>
                <option value="G√ºni">G√ºni</option>
                <option value="Tobi">Tobi</option>
              </select>

              <input class="input" id="msgTrainer" style="margin-top:10px" placeholder="Nachricht schreiben‚Ä¶" />
              <button class="btn primary" style="margin-top:10px;width:100%" onclick="sendMsg()">Senden</button>
            </div>

          </div>
        </div>
      </div>

    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <div class="cardPad">
          <h2>üöÄ SmartGen Quick</h2>
          <div class="small">
            - Spieler: Analyse (Kreis), Score-Chart, Sessions, Anwesenheit/Woche, Slots, Ern√§hrung<br>
            - Eltern: KI Motivation, Kalender, Fitness Buchung (mit Sperre), Kommunikation + Trainerwahl
          </div>

          <div class="hr"></div>

          <button class="btn primary" style="width:100%" onclick="toggleStatus()">üîÅ Status wechseln</button>
          <button class="btn" style="width:100%; margin-top:10px" onclick="switchTrainer()">üë• Trainer wechseln</button>

          <div class="hr"></div>
          <div class="small">
            Eltern PIN: <b>1234</b>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- PIN MODAL -->
<div id="pinModal" class="modalWrap">
  <div class="modal">
    <div class="modalHead">
      <b>üîê Eltern-Freigabe (PIN)</b>
      <button class="x" onclick="closePin()">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="small">Demo-PIN: <b>1234</b></div>
      <div style="margin-top:10px">
        <input id="pinInput" class="input" placeholder="PIN eingeben" inputmode="numeric">
      </div>
    </div>
    <div class="modalActions">
      <button class="btn" onclick="closePin()">Abbrechen</button>
      <button class="btn primary" onclick="checkPin()">Freigeben</button>
    </div>
  </div>
</div>

<!-- BOOK MODAL -->
<div id="bookModal" class="modalWrap">
  <div class="modal">
    <div class="modalHead">
      <b id="bookTitle">Slot buchen</b>
      <button class="x" onclick="closeBook()">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="small" id="bookInfo"></div>
      <div style="margin-top:12px">
        <label class="small"><b>Typ</b></label>
        <select id="bookType" class="input" style="margin-top:6px"></select>
      </div>
      <div style="margin-top:12px">
        <label class="small"><b>Notiz</b></label>
        <input id="bookNote" class="input" style="margin-top:6px" placeholder="Optional‚Ä¶">
      </div>
    </div>
    <div class="modalActions">
      <button class="btn" onclick="closeBook()">Abbrechen</button>
      <button class="btn ok" onclick="confirmBooking()">‚úÖ Buchen</button>
    </div>
  </div>
</div>

<!-- EVENT MODAL -->
<div id="eventModal" class="modalWrap">
  <div class="modal">
    <div class="modalHead">
      <b>üóìÔ∏è Event hinzuf√ºgen</b>
      <button class="x" onclick="closeEventModal()">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="small">W√§hle Tag + Titel (Demo)</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
        <select class="input" id="evDay">
          <option value="1">Mo</option>
          <option value="2">Di</option>
          <option value="3">Mi</option>
          <option value="4">Do</option>
          <option value="5">Fr</option>
          <option value="6">Sa</option>
          <option value="0">So</option>
        </select>
        <input class="input" id="evTitle" placeholder="z.B. Arzt / Training / Termin">
      </div>
      <div style="margin-top:10px">
        <select class="input" id="evType">
          <option value="orange">SmartGen</option>
          <option value="normal">Normal</option>
        </select>
      </div>
    </div>
    <div class="modalActions">
      <button class="btn" onclick="closeEventModal()">Abbrechen</button>
      <button class="btn primary" onclick="addEvent()">Hinzuf√ºgen</button>
    </div>
  </div>
</div>

<!-- WALLET MODAL -->
<div id="walletModal" class="modalWrap">
  <div class="modal">
    <div class="modalHead">
      <b id="walletTitle">üß° SmartGen Wallet</b>
      <button class="x" onclick="closeWallet()">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="idCard">
        <div class="idTop">
          <div>
            <div class="idName" id="walletName">SmartGen</div>
            <div class="idSub" id="walletSub">Wallet/NFC ‚Ä¢ Demo</div>
          </div>
          <div class="nfcPill">üì∂ NFC aktiv</div>
        </div>

        <div class="idGrid" id="walletGrid"></div>

        <div class="qr">
          <div class="qrBox" title="QR Demo"></div>
          <div style="flex:1;min-width:220px">
            <div style="font-weight:1000">Check-in / Zugang</div>
            <div class="small">QR scannen oder NFC tap (Demo).</div>
            <button class="btn primary" style="margin-top:10px" onclick="simulateNFC()">üì∂ NFC Tap simulieren</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modalActions">
      <button class="btn" onclick="closeWallet()">Schlie√üen</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   CONFIG / STATE
========================= */
const PARENT_PIN = "1234";

const member = {
  name: "Amine B.",
  year: 2012,
  meta: "U15 ‚Ä¢ Technik & Kognition",
  contract: "Premium ‚Ä¢ Laufend",
  emergency: "Parent One ‚Ä¢ +49 ‚Ä¶",
  trainer: "Salem",
  status: "Aktiv",
};

const trainers = ["Salem","G√ºni","Tobi"];
let currentTrainerIdx = 0;

let mode = "player";
let bookingContext = null;
let walletMode = "player";
let playerCategory = "Technik";

let parentSelectedTrainer = "Salem";

const KEY_PARENT_BOOK = "sg_parent_bookings_v3";
const KEY_PLAYER_BOOK = "sg_player_bookings_v2";
const KEY_EVENTS_PLAYER = "sg_events_player_v1";
const KEY_EVENTS_PARENT = "sg_events_parent_v1";
const KEY_ANALYTICS = "sg_analytics_v2";
const KEY_SESSIONS = "sg_sessions_v1";

/* Kid training blocks */
const kidTrainings = [
  { day: 3, start: "18:00", end: "19:30", label: "Kindertraining (Mi 18:00‚Äì19:30)" },
  { day: 5, start: "17:30", end: "19:00", label: "Kindertraining (Fr 17:30‚Äì19:00)" },
  { day: 6, start: "10:00", end: "11:30", label: "Kindertraining (Sa 10:00‚Äì11:30)" },
];

/* Parent fitness slots */
const fitnessSlotsCatalog = [
  { id:"mon_0900", day:1, start:"09:00", end:"10:00", title:"Eltern Fitness", desc:"Kraft ‚Ä¢ Core" },
  { id:"mon_1100", day:1, start:"11:00", end:"12:00", title:"Eltern Fitness", desc:"Cardio ‚Ä¢ Intervall" },
  { id:"tue_0930", day:2, start:"09:30", end:"10:30", title:"Mobility", desc:"Beweglichkeit ‚Ä¢ R√ºcken" },
  { id:"wed_1700", day:3, start:"17:00", end:"18:00", title:"Eltern Fitness", desc:"Kraft ‚Ä¢ Basics" },
  { id:"wed_1830", day:3, start:"18:30", end:"19:30", title:"Eltern Fitness", desc:"Cardio ‚Ä¢ HIIT" },
  { id:"fri_0900", day:5, start:"09:00", end:"10:00", title:"Regeneration", desc:"Stretch ‚Ä¢ Atmung" },
  { id:"fri_1800", day:5, start:"18:00", end:"19:00", title:"Eltern Fitness", desc:"Kraft ‚Ä¢ Mix" },
  { id:"sat_1830", day:6, start:"18:30", end:"19:30", title:"Eltern Fitness", desc:"Abend Slot" },
];

/* Player slots by categories */
const playerSlotsCatalog = [
  { id:"tue_1700_tech", cat:"Technik", day:2, start:"17:00", end:"18:00", title:"Privattraining", desc:"Erster Kontakt ‚Ä¢ Ballf√ºhrung" },
  { id:"thu_1800_tech", cat:"Technik", day:4, start:"18:00", end:"19:00", title:"Technik Session", desc:"Passen ‚Ä¢ Ballkontrolle" },

  { id:"wed_1700_ath", cat:"Athletik", day:3, start:"17:00", end:"18:00", title:"Athletik", desc:"Schnelligkeit ‚Ä¢ Core" },
  { id:"sat_1200_ath", cat:"Athletik", day:6, start:"12:00", end:"13:00", title:"Athletik+", desc:"Stabilit√§t ‚Ä¢ Sprint" },

  { id:"thu_1830_kog", cat:"Kognition", day:4, start:"18:30", end:"19:30", title:"Kognitives Training", desc:"Scanning ‚Ä¢ Reaktion" },
  { id:"fri_1800_kog", cat:"Kognition", day:5, start:"18:00", end:"19:00", title:"Matchanalyse", desc:"KPIs ‚Ä¢ Video Hinweise" },
];

/* =========================
   HELPERS
========================= */
function $(id){ return document.getElementById(id); }
function toast(msg){
  const t = $("toast");
  t.innerHTML = msg;
  t.style.display = "block";
  clearTimeout(window.__to);
  window.__to = setTimeout(()=> t.style.display="none", 2600);
}
function dayName(d){ return ["So","Mo","Di","Mi","Do","Fr","Sa"][d]; }
function toMin(hhmm){ const [h,m]=hhmm.split(":").map(Number); return h*60+m; }
function overlaps(aStart,aEnd,bStart,bEnd){ return Math.max(aStart,bStart) < Math.min(aEnd,bEnd); }

function setStatusUI(text){
  $("statusText").textContent = text;
  const dot = $("statusDot");
  dot.style.background = (text==="Aktiv") ? "var(--ok)" : (text==="Pause") ? "var(--warn)" : "var(--danger)";
  dot.style.boxShadow = (text==="Aktiv")
    ? "0 0 0 6px rgba(37,208,127,.10)"
    : (text==="Pause")
      ? "0 0 0 6px rgba(255,176,32,.10)"
      : "0 0 0 6px rgba(255,77,77,.10)";
}

function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  }catch(e){ return fallback; }
}
function saveJSON(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

function loadBookings(key){ return loadJSON(key, []); }
function saveBookings(key, list){ saveJSON(key, list); }
function isBooked(key, slotId){ return loadBookings(key).some(b => b.slotId === slotId); }

function todayISO(){
  const d = new Date();
  return d.toISOString().slice(0,10);
}

/* =========================
   TABS
========================= */
function showTab(scope, name){
  const tabs = scope==="player"
    ? ["Analyse","Kalender","Slots","Ernaehrung","Daten"]
    : ["KI","Kalender","Fitness","Daten"];

  tabs.forEach(t=>{
    const el = $(scope+"_"+t);
    const btn = $("tab"+(scope==="player"?"P":"E")+"_"+t);
    if(el) el.classList.toggle("hidden", t!==name);
    if(btn) btn.classList.toggle("active", t===name);
  });

  if(scope==="player" && name==="Kalender") renderCalendar("player");
  if(scope==="parent" && name==="Kalender") renderCalendar("parent");
  if(scope==="player" && name==="Slots") renderPlayerSlots();
  if(scope==="parent" && name==="Fitness") renderFitness();
  if(scope==="player" && name==="Analyse") renderPlayerAnalysis();
}

/* =========================
   MODE / PIN
========================= */
function setMode(next){
  mode = next;
  document.body.classList.toggle("parent", mode==="parent");
  $("modeLabel").textContent = "Modus: " + (mode==="parent" ? "Eltern (Orange Neon)" : "Spieler");

  $("playerDash").classList.toggle("hidden", mode !== "player");
  $("parentDash").classList.toggle("hidden", mode !== "parent");

  if(mode==="player") showTab("player","Analyse");
  if(mode==="parent") showTab("parent","KI");

  setStatusUI(member.status);
  syncHeaderTags();
  renderAll();
}

function openPin(){
  $("pinModal").style.display = "flex";
  $("pinInput").value = "";
  $("pinInput").focus();
}
function closePin(){ $("pinModal").style.display = "none"; }
function checkPin(){
  const pin = $("pinInput").value.trim();
  if(pin === PARENT_PIN){
    closePin();
    setMode("parent");
    toast("‚úÖ <b>Eltern-Freigabe aktiv</b>");
  } else {
    toast("‚ùå <b>Falscher PIN</b><br>Bitte erneut versuchen.");
  }
}

/* =========================
   BOOKING
========================= */
function isBlockedByKidTraining(slot){
  const sA = toMin(slot.start), sB = toMin(slot.end);
  const blocks = kidTrainings.filter(k=>k.day === slot.day);
  for(const k of blocks){
    const kA = toMin(k.start), kB = toMin(k.end);
    if(overlaps(sA,sB,kA,kB)) return {blocked:true, reason:k.label};
  }
  return {blocked:false, reason:""};
}

function renderFitness(){
  const list = $("fitnessSlots");
  if(!list) return;
  list.innerHTML = "";

  const bookings = loadBookings(KEY_PARENT_BOOK);
  $("bookCount").textContent = bookings.length;

  const sorted = [...fitnessSlotsCatalog].sort((a,b)=>{
    if(a.day !== b.day) return a.day - b.day;
    return toMin(a.start) - toMin(b.start);
  });

  for(const slot of sorted){
    const blockInfo = isBlockedByKidTraining(slot);
    const booked = isBooked(KEY_PARENT_BOOK, slot.id);

    const div = document.createElement("div");
    div.className = "slot";

    const statusTag = blockInfo.blocked
      ? `<span class="tag danger">Gesperrt</span>`
      : booked
        ? `<span class="tag ok">Gebucht</span>`
        : `<span class="tag warn">Frei</span>`;

    const actionBtn = blockInfo.blocked
      ? `<button class="btn" disabled>‚õî</button>`
      : booked
        ? `<button class="btn ghost" onclick="cancelBooking('parent','${slot.id}')">Storno</button>`
        : `<button class="btn ok" onclick="openBook('parent','${slot.id}')">Buchen</button>`;

    div.innerHTML = `
      <div>
        <strong>${dayName(slot.day)} ‚Ä¢ ${slot.start}‚Äì${slot.end} ‚Äî ${slot.title}</strong>
        <small>${slot.desc}${blockInfo.blocked ? " ‚Ä¢ <b>Block:</b> "+blockInfo.reason : ""}</small>
      </div>
      <div class="right">
        ${statusTag}
        ${actionBtn}
      </div>
    `;
    list.appendChild(div);
  }
}

function setCategory(cat){
  playerCategory = cat;
  $("playerCat").textContent = cat;
  renderPlayerSlots();
}

function renderPlayerSlots(){
  const list = $("playerSlots");
  if(!list) return;
  list.innerHTML = "";

  const filtered = playerSlotsCatalog.filter(s=>s.cat===playerCategory)
    .sort((a,b)=> (a.day-b.day) || (toMin(a.start)-toMin(b.start)));

  for(const slot of filtered){
    const booked = isBooked(KEY_PLAYER_BOOK, slot.id);

    const div = document.createElement("div");
    div.className = "slot";

    const statusTag = booked ? `<span class="tag ok">Gebucht</span>` : `<span class="tag warn">Frei</span>`;
    const actionBtn = booked
      ? `<button class="btn ghost" onclick="cancelBooking('player','${slot.id}')">Storno</button>`
      : `<button class="btn ok" onclick="openBook('player','${slot.id}')">Buchen</button>`;

    div.innerHTML = `
      <div>
        <strong>${dayName(slot.day)} ‚Ä¢ ${slot.start}‚Äì${slot.end} ‚Äî ${slot.title}</strong>
        <small>${slot.desc}</small>
      </div>
      <div class="right">
        ${statusTag}
        ${actionBtn}
      </div>
    `;
    list.appendChild(div);
  }
}

/* Book Modal shared */
function openBook(kind, slotId){
  bookingContext = { kind, slotId };

  const isParent = kind === "parent";
  const catalog = isParent ? fitnessSlotsCatalog : playerSlotsCatalog;
  const slot = catalog.find(s=>s.id===slotId);
  if(!slot) return;

  if(isParent){
    const blockInfo = isBlockedByKidTraining(slot);
    if(blockInfo.blocked){
      toast("‚õî <b>Gesperrt</b><br>Dieser Slot kollidiert mit Kindertraining.");
      bookingContext = null;
      return;
    }
    if(isBooked(KEY_PARENT_BOOK, slotId)){
      toast("‚úÖ <b>Schon gebucht</b>");
      bookingContext = null;
      return;
    }
  } else {
    if(isBooked(KEY_PLAYER_BOOK, slotId)){
      toast("‚úÖ <b>Schon gebucht</b>");
      bookingContext = null;
      return;
    }
  }

  $("bookTitle").textContent = `${isParent ? "Eltern" : "Spieler"} Slot buchen: ${dayName(slot.day)} ${slot.start}‚Äì${slot.end}`;
  $("bookInfo").innerHTML = `<b>${slot.title}</b> ‚Äì ${slot.desc}`;

  const sel = $("bookType");
  sel.innerHTML = "";
  const options = isParent
    ? ["Eltern Fitness ‚Äì Kraft","Eltern Fitness ‚Äì Cardio","Mobility / R√ºcken","Regeneration / Stretching"]
    : (playerCategory==="Technik"
        ? ["Technik ‚Äì 1. Kontakt","Technik ‚Äì Passen","Technik ‚Äì Dribbling"]
        : playerCategory==="Athletik"
          ? ["Athletik ‚Äì Speed","Athletik ‚Äì Core","Athletik ‚Äì Stability"]
          : ["Kognition ‚Äì Reaktion","Kognition ‚Äì Scanning","Matchanalyse"]);
  options.forEach(o=>{
    const opt = document.createElement("option");
    opt.textContent = o;
    sel.appendChild(opt);
  });

  $("bookNote").value = "";
  $("bookModal").style.display = "flex";
}
function closeBook(){
  $("bookModal").style.display = "none";
  bookingContext = null;
}
function confirmBooking(){
  if(!bookingContext) return;
  const { kind, slotId } = bookingContext;
  const isParent = kind === "parent";
  const catalog = isParent ? fitnessSlotsCatalog : playerSlotsCatalog;
  const slot = catalog.find(s=>s.id===slotId);
  if(!slot) return;

  const type = $("bookType").value;
  const note = $("bookNote").value.trim();

  const key = isParent ? KEY_PARENT_BOOK : KEY_PLAYER_BOOK;
  const bookings = loadBookings(key);
  bookings.push({ slotId, createdAt:new Date().toISOString(), type, note });
  saveBookings(key, bookings);

  closeBook();

  if(isParent) renderFitness();
  else renderPlayerSlots();

  bumpAnalytics(isParent ? "parentFitness" : "playerSlot");

  toast(`‚úÖ <b>Buchung best√§tigt</b><br>${dayName(slot.day)} ${slot.start}‚Äì${slot.end} ‚Ä¢ ${type}${note? "<br><span class='small'>Notiz: "+note+"</span>":""}`);
}

function cancelBooking(kind, slotId){
  const isParent = kind === "parent";
  const key = isParent ? KEY_PARENT_BOOK : KEY_PLAYER_BOOK;
  const catalog = isParent ? fitnessSlotsCatalog : playerSlotsCatalog;
  const slot = catalog.find(s=>s.id===slotId);

  const bookings = loadBookings(key).filter(b => b.slotId !== slotId);
  saveBookings(key, bookings);

  if(isParent) renderFitness();
  else renderPlayerSlots();

  toast(`üóëÔ∏è <b>Storniert</b><br>${slot ? (dayName(slot.day)+" "+slot.start+"‚Äì"+slot.end) : "Slot"} entfernt.`);
}

function resetParentBookings(){
  localStorage.removeItem(KEY_PARENT_BOOK);
  renderFitness();
  toast("üßπ <b>Reset</b><br>Alle Eltern-Buchungen gel√∂scht.");
}

/* =========================
   WALLET / NFC
========================= */
function openWallet(kind){
  walletMode = kind;
  $("walletModal").style.display="flex";

  if(kind === "player"){
    $("walletTitle").textContent = "‚öΩ Spieler Wallet / NFC";
    $("walletName").textContent = "Spieler-ID ‚Ä¢ SmartGen";
    $("walletSub").textContent = "Orange NFC ‚Ä¢ Check-in (Demo)";
    $("walletGrid").innerHTML = `
      <div class="kv"><b>Spieler</b><span>${member.name}</span></div>
      <div class="kv"><b>Team</b><span>U15</span></div>
      <div class="kv"><b>Trainer</b><span>${member.trainer}</span></div>
      <div class="kv"><b>Status</b><span>${member.status}</span></div>
    `;
  } else {
    $("walletTitle").textContent = "üß° Eltern Wallet / NFC";
    $("walletName").textContent = "Eltern-ID ‚Ä¢ SmartGen";
    $("walletSub").textContent = "Orange Neon Edition (Demo)";
    $("walletGrid").innerHTML = `
      <div class="kv"><b>Elternteil</b><span>Parent One</span></div>
      <div class="kv"><b>Kind</b><span>${member.name}</span></div>
      <div class="kv"><b>Vertrag</b><span>Premium</span></div>
      <div class="kv"><b>Status</b><span>Aktiv</span></div>
    `;
  }
}
function closeWallet(){ $("walletModal").style.display="none"; }
function simulateNFC(){
  bumpAnalytics("checkin");
  toast(`üì∂ <b>NFC Tap OK</b><br>${walletMode==="player" ? "Spieler" : "Eltern"} Check-in registriert (Demo).`);
}

/* =========================
   CALENDAR
========================= */
let eventScope = "player";

function openEventModal(scope){
  eventScope = scope;
  $("eventModal").style.display = "flex";
  $("evDay").value = "3";
  $("evTitle").value = "";
  $("evType").value = "orange";
}
function closeEventModal(){ $("eventModal").style.display = "none"; }
function addEvent(){
  const d = parseInt($("evDay").value,10);
  const title = $("evTitle").value.trim() || "Event";
  const type = $("evType").value;

  const key = eventScope==="player" ? KEY_EVENTS_PLAYER : KEY_EVENTS_PARENT;
  const events = loadJSON(key, []);
  events.push({day:d, title, type});
  saveJSON(key, events);

  closeEventModal();
  renderCalendar(eventScope);
  bumpAnalytics("calendar");
  toast("‚úÖ <b>Event hinzugef√ºgt</b>");
}

function renderCalendar(scope){
  const grid = scope==="player" ? $("calPlayer") : $("calParent");
  if(!grid) return;
  grid.innerHTML = "";

  const key = scope==="player" ? KEY_EVENTS_PLAYER : KEY_EVENTS_PARENT;
  const customEvents = loadJSON(key, []);

  const base = [];
  kidTrainings.forEach(k=> base.push({day:k.day, title:k.label, type:"orange"}));

  if(scope==="parent"){
    const b = loadBookings(KEY_PARENT_BOOK);
    b.forEach(x=>{
      const s = fitnessSlotsCatalog.find(z=>z.id===x.slotId);
      if(s) base.push({day:s.day, title:`Eltern Fitness ${s.start}`, type:"orange"});
    });
  }
  if(scope==="player"){
    const b = loadBookings(KEY_PLAYER_BOOK);
    b.forEach(x=>{
      const s = playerSlotsCatalog.find(z=>z.id===x.slotId);
      if(s) base.push({day:s.day, title:`${s.title} ${s.start}`, type:"orange"});
    });
  }

  const all = [...base, ...customEvents];

  for(let day=1; day<=7; day++){
    const d = day%7;
    const box = document.createElement("div");
    box.className = "dayBox";
    box.innerHTML = `<div class="dayName">${dayName(d)}</div>`;
    const items = all.filter(e=>e.day===d);

    items.slice(0,4).forEach(e=>{
      const ev = document.createElement("div");
      ev.className = "event " + (e.type==="orange" ? "orange":"");
      ev.textContent = e.title;
      box.appendChild(ev);
    });

    if(items.length>4){
      const more = document.createElement("div");
      more.className = "small";
      more.style.marginTop = "8px";
      more.innerHTML = `<b>+${items.length-4}</b> mehr‚Ä¶`;
      box.appendChild(more);
    }

    grid.appendChild(box);
  }
}

/* =========================
   PARENT COMMUNICATION UPGRADE
========================= */
function parentSelectTrainer(){
  parentSelectedTrainer = $("parentTrainerSelect").value;
  $("parentTrainerTag").textContent = "Trainer: " + parentSelectedTrainer;
  toast(`‚úÖ Trainer gew√§hlt: <b>${parentSelectedTrainer}</b>`);
}
function sendMsg(){
  const txt = $("msgTrainer").value.trim();
  if(!txt){ toast("‚ö†Ô∏è Bitte Nachricht schreiben."); return; }
  $("msgTrainer").value = "";
  bumpAnalytics("calendar");
  toast(`üì® <b>Gesendet</b><br>An: <b>${parentSelectedTrainer}</b> (Demo)`);
}

/* =========================
   PLAYER NUTRITION + MOTIVATION
========================= */
function genPlayerNutrition(){
  const style = $("p_nutri_style").value;
  const allergy = $("p_nutri_allergy").value;

  const base = {
    familie: {
      fr: "Haferflocken + Banane (oder Brot + Ei)",
      mi: "Reis/Pasta + H√§hnchen/Thunfisch + Gem√ºse",
      ab: "Kartoffeln + Quark/Joghurt + Salat",
      sn: "Apfel + Skyr",
      wa: "1.5‚Äì2L Wasser"
    },
    sport: {
      fr: "Oats + Beeren + Protein (oder Omelett)",
      mi: "Reis + Chicken + Gem√ºse + Oliven√∂l",
      ab: "Lachs/Thunfisch + Kartoffeln + Salat",
      sn: "Banane + Skyr",
      wa: "2L Wasser + Elektrolyte"
    },
    low: {
      fr: "Joghurt + Obst + Honig",
      mi: "Salat Bowl + Protein + Brot",
      ab: "Gem√ºsepfanne + Ei/Fisch",
      sn: "Obst + Tee",
      wa: "1.5‚Äì2L Wasser"
    }
  };
  let plan = base[style] || base.familie;

  const allergyNote = (a)=>{
    if(a==="laktose") return " (laktosefrei)";
    if(a==="nuesse") return " (ohne N√ºsse)";
    if(a==="gluten") return " (glutenfrei)";
    return "";
  };
  const note = allergyNote(allergy);

  $("p_nutri_plan").textContent =
    `Fr√ºhst√ºck: ${plan.fr}${note} ‚Ä¢ Mittag: ${plan.mi}${note} ‚Ä¢ Abend: ${plan.ab}${note} ‚Ä¢ Snack: ${plan.sn}${note} ‚Ä¢ Wasser: ${plan.wa}`;

  toast("‚úÖ <b>Ern√§hrungsplan erstellt</b>");
}
function genPlayerMotivation(){
  const arr = [
    "Heute bist du schneller als gestern.",
    "Fokus. Erste Ber√ºhrung. Kopf hoch.",
    "Du trainierst smart ‚Äì das ist dein Vorteil.",
    "Mach‚Äôs einfach: Kontrolle, Tempo, Entscheidung."
  ];
  $("p_motivation").textContent = "üî• " + arr[Math.floor(Math.random()*arr.length)];
  toast("‚úÖ <b>Motivation bereit</b>");
}

/* =========================
   ANALYTICS (Donuts + Sessions)
========================= */
function defaultAnalytics(){
  return { attendance: 78, progress: 52, performance: 74 };
}
function getAnalytics(){ return loadJSON(KEY_ANALYTICS, defaultAnalytics()); }
function setAnalytics(a){ saveJSON(KEY_ANALYTICS, a); }

function bumpAnalytics(type){
  const a = getAnalytics();
  if(type==="checkin") a.attendance = clamp(a.attendance + 1, 0, 100);
  if(type==="playerSlot") a.progress = clamp(a.progress + 1, 0, 100);
  if(type==="parentFitness") a.performance = clamp(a.performance + 1, 0, 100);
  if(type==="calendar") a.progress = clamp(a.progress + 1, 0, 100);
  setAnalytics(a);
  renderDonuts();
}

function setArc(pathEl, percent){
  const total = 157;
  const filled = Math.round((percent/100)*total);
  pathEl.setAttribute("stroke-dasharray", `${filled} ${total}`);
}
function renderDonuts(){
  const a = getAnalytics();
  $("d_att").textContent = `${a.attendance}%`;
  $("d_prog").textContent = `${a.progress}%`;
  $("d_perf").textContent = `${a.performance}/100`;
  setArc($("arc_att"), a.attendance);
  setArc($("arc_prog"), a.progress);
  setArc($("arc_perf"), a.performance);
}

/* Sessions model */
function seedSessions(){
  const existing = loadJSON(KEY_SESSIONS, null);
  if(existing) return;

  const base = [];
  const types = ["Technik","Athletik","Kognition","Matchanalyse"];
  let dayBack = 1;
  for(let i=0;i<10;i++){
    const d = new Date();
    d.setDate(d.getDate()-dayBack);
    dayBack += 2;

    const present = Math.random() > 0.15;
    const score = present ? Math.floor(65 + Math.random()*25) : 0;

    base.unshift({
      date: d.toISOString().slice(0,10),
      type: types[Math.floor(Math.random()*types.length)],
      present,
      score
    });
  }
  saveJSON(KEY_SESSIONS, base);
}

function sessions(){ return loadJSON(KEY_SESSIONS, []); }
function saveSessions(list){ saveJSON(KEY_SESSIONS, list); }

function addRandomSession(){
  const list = sessions();
  const types = ["Technik","Athletik","Kognition","Matchanalyse"];
  const present = Math.random() > 0.10;
  const score = present ? Math.floor(65 + Math.random()*25) : 0;
  const d = new Date();
  d.setDate(d.getDate() - Math.floor(Math.random()*6));
  list.push({
    date: d.toISOString().slice(0,10),
    type: types[Math.floor(Math.random()*types.length)],
    present,
    score
  });
  list.sort((a,b)=> a.date.localeCompare(b.date));
  saveSessions(list);
  renderPlayerAnalysis();
  toast("‚úÖ <b>Demo Session hinzugef√ºgt</b>");
}

function markToday(present){
  const list = sessions();
  const t = todayISO();
  const idx = list.findIndex(s=>s.date===t);
  const score = present ? Math.floor(65 + Math.random()*25) : 0;
  const type = present ? "Technik" : "‚Äî";
  if(idx>=0){
    list[idx] = {date:t, type, present, score};
  }else{
    list.push({date:t, type, present, score});
  }
  list.sort((a,b)=> a.date.localeCompare(b.date));
  saveSessions(list);

  // update analytics quick
  const a = getAnalytics();
  a.attendance = clamp(a.attendance + (present?1:-1), 0, 100);
  a.performance = clamp(a.performance + (present?1:-1), 0, 100);
  setAnalytics(a);

  renderPlayerAnalysis();
  toast(present ? "‚úÖ <b>Heute: anwesend</b>" : "‚ùå <b>Heute: gefehlt</b>");
}

function renderSessionList(){
  const listEl = $("sessionList");
  if(!listEl) return;
  listEl.innerHTML = "";

  const list = sessions().slice(-14).reverse(); // newest first
  list.forEach(s=>{
    const div = document.createElement("div");
    div.className = "slot";
    const tag = s.present ? `<span class="tag ok">Anwesend</span>` : `<span class="tag danger">Gefehlt</span>`;
    div.innerHTML = `
      <div>
        <strong>${s.date} ‚Ä¢ ${s.type}</strong>
        <small>Score: <b>${s.present ? s.score : 0}</b>/100</small>
      </div>
      <div class="right">${tag}</div>
    `;
    listEl.appendChild(div);
  });

  if(!list.length){
    listEl.innerHTML = `<div class="small">Keine Sessions vorhanden.</div>`;
  }
}

function drawScoreChart(){
  const c = $("scoreChart");
  if(!c) return;
  const ctx = c.getContext("2d");

  const list = sessions().slice(-10);
  const w = c.width, h = c.height;
  ctx.clearRect(0,0,w,h);

  // grid
  ctx.globalAlpha = 0.20;
  ctx.strokeStyle = "#ffffff";
  for(let y=30;y<h;y+=50){
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
  }
  ctx.globalAlpha = 1;

  const pad = 46;
  const chartW = w - pad*2;
  const chartH = h - pad*2;

  // axis
  ctx.globalAlpha = 0.35;
  ctx.beginPath();
  ctx.moveTo(pad, pad);
  ctx.lineTo(pad, pad+chartH);
  ctx.lineTo(pad+chartW, pad+chartH);
  ctx.stroke();
  ctx.globalAlpha = 1;

  if(list.length < 2){
    ctx.globalAlpha = 0.8;
    ctx.fillStyle = "#ffffff";
    ctx.fillText("Noch keine Daten.", pad, pad+30);
    ctx.globalAlpha = 1;
    return;
  }

  // line
  const step = chartW/(list.length-1);
  ctx.lineWidth = 3;
  ctx.strokeStyle = "#ff7a18";
  ctx.beginPath();
  list.forEach((s,i)=>{
    const x = pad + step*i;
    const v = s.present ? s.score : 0;
    const y = pad + chartH - (v/100)*chartH;
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // points
  list.forEach((s,i)=>{
    const x = pad + step*i;
    const v = s.present ? s.score : 0;
    const y = pad + chartH - (v/100)*chartH;

    ctx.globalAlpha = s.present ? 0.95 : 0.35;
    ctx.fillStyle = "#ff7a18";
    ctx.beginPath();
    ctx.arc(x,y,7,0,Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;

    // labels
    ctx.globalAlpha = 0.8;
    ctx.fillStyle = "#ffffff";
    ctx.font = "12px system-ui";
    ctx.fillText(String(v), x-8, y-12);
    ctx.globalAlpha = 1;
  });
}

function renderWeeklyAttendance(){
  const list = sessions();
  // demo: split into 3 blocks of 7 days by time order
  const sorted = [...list].sort((a,b)=> a.date.localeCompare(b.date));
  const last21 = sorted.slice(-21);

  const blocks = [ last21.slice(-7), last21.slice(-14,-7), last21.slice(-21,-14) ];
  const ids = ["wkA","wkB","wkC"];

  blocks.forEach((b,idx)=>{
    const total = b.length || 1;
    const present = b.filter(x=>x.present).length;
    const pct = Math.round((present/total)*100);
    const el = $(ids[idx]);
    if(el) el.style.width = pct + "%";
  });
}

function renderPlayerAnalysis(){
  renderDonuts();
  renderSessionList();
  drawScoreChart();
  renderWeeklyAttendance();
}

/* =========================
   PARENT KI MOTIVATION (unchanged)
========================= */
function genMotivation(){
  const goal = $("ki_goal").value;
  const mood = $("ki_mood").value;

  const bank = {
    energie: [
      "Heute: kleine Schritte, gro√üe Wirkung.",
      "Mach‚Äôs smart: Wasser, Bewegung, fertig.",
      "Du brauchst nicht perfekt sein ‚Äî nur konstant."
    ],
    kraft: [
      "Stark sein ist eine Entscheidung ‚Äî heute starten.",
      "Jede Wiederholung z√§hlt. Fokus, sauber, smart.",
      "Konstanz gewinnt. Nicht Stress."
    ],
    abnehmen: [
      "Ein guter Tag beginnt mit einem guten Plan.",
      "Smart essen, smart bewegen ‚Äî du schaffst das.",
      "Kleine Entscheidungen ‚Üí gro√üe Resultate."
    ],
    stress: [
      "Atmen. Dann handeln. Du f√ºhrst den Tag.",
      "Ruhig bleiben: 10 Minuten Bewegung reichen.",
      "Weniger Chaos, mehr Struktur ‚Äî SmartGen."
    ]
  };

  const style = (txt)=>{
    if(mood==="kurz") return "üî• " + txt;
    if(mood==="coach") return "Coach: " + txt + " Let‚Äôs go.";
    return "üôÇ " + txt;
  };

  const arr = bank[goal] || bank.energie;
  const pick = arr[Math.floor(Math.random()*arr.length)];
  $("ki_motivation").textContent = style(pick);

  toast("‚úÖ <b>Motivation erstellt</b>");
}

/* =========================
   HEADER TAGS / ACTIONS
========================= */
function syncHeaderTags(){
  $("pMetaTag").textContent = member.meta;
  $("pTrainerTag").textContent = "Trainer: " + member.trainer;
  $("pStatusTag").textContent = member.status;
  setStatusUI(member.status);

  $("pd_name").textContent = member.name;
  $("pd_year").textContent = member.year;
  $("pd_contract").textContent = member.contract;
  $("pd_emg").textContent = member.emergency;

  $("parentTrainerTag").textContent = "Trainer: " + parentSelectedTrainer;
  const sel = $("parentTrainerSelect");
  if(sel) sel.value = parentSelectedTrainer;
}

function toggleStatus(){
  const order = ["Aktiv","Pause","Verletzung"];
  const idx = order.indexOf(member.status);
  member.status = order[(idx+1)%order.length];
  syncHeaderTags();
  toast(`üîÅ Status: <b>${member.status}</b>`);
}

function switchTrainer(){
  currentTrainerIdx = (currentTrainerIdx+1) % trainers.length;
  member.trainer = trainers[currentTrainerIdx];
  syncHeaderTags();
  toast(`üë• Trainer: <b>${member.trainer}</b>`);
}

/* =========================
   MODALS: EVENT / BOOK / WALLET (same)
========================= */
function closeWallet(){ $("walletModal").style.display="none"; }

/* Event modal handlers already defined above */

/* =========================
   INIT
========================= */
function renderAll(){
  syncHeaderTags();
  renderPlayerSlots();
  renderFitness();
  renderCalendar("player");
  renderCalendar("parent");
  renderPlayerAnalysis();
}

seedSessions();
setMode("player");
renderAll();

/* =========================
   Missing functions: closeEventModal, closeBook, closeWallet are above.
   (already defined)
========================= */

/* Re-define closeEventModal & closeBook in case load order */
function closeEventModal(){ $("eventModal").style.display = "none"; }
function closeBook(){ $("bookModal").style.display = "none"; bookingContext=null; }
function closeWallet(){ $("walletModal").style.display="none"; }

/* Wallet simulate NFC */
function simulateNFC(){
  bumpAnalytics("checkin");
  toast(`üì∂ <b>NFC Tap OK</b><br>${walletMode==="player" ? "Spieler" : "Eltern"} Check-in registriert (Demo).`);
}

/* Booking close (already) */
</script>
</body>
</html>
